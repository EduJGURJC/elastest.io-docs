
<div class="range range-xs-left">
<div class="cell-xs-10 cell-lg-6 text-md-left inset-md-right-80 cell-lg-push-1 offset-top-50 offset-lg-top-0">
<h2 id="content" class="h1">Pipeline Job</h2>
<div class="offset-top-30 offset-md-top-30">
</div>
</div>
</div>

From a Pipeline this plugin allows:

-   Send the Jobâ€™s logs to ElasTest.
-   Use the browsers you need in the tests executed during a build. To do this, you must indicate that you want the provision of a EUS TSS, passing this requirement as a parameter in the plugin.
-   Send logs and metrics of a dockerized SUT from a Job's execution to ElasTest and the logs generated by the browsers used.

-   Run a SUT using docker or docker-compose

<h5 class="small-subtitle">Basics examples</h5>

<h6 class="small-subtitle">Example 1</h6>
This code will be us useful, due to, adding it in the Pipeline script and executing the Pipeline, it will download the [ demo-projects ](https://github.com/elastest/demo-projects) repository and it will run the test.

```
node{
    elastest() {
        stage ('Executing Test') {
            echo 'Print env variables'
            sh 'env'
            mvnHome = tool 'M3.3.9'
            echo 'Cloning repository'
            git 'https://github.com/elastest/demo-projects'
            echo 'Run test'
            sh "cd ./unit-java-test/;'${mvnHome}/bin/mvn' test"
        }
    }
}
```

<p></p>
<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-2" href="/docs/jenkins/images/pipeline.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/pipeline.png"/></a>
</div>

<h6 class="small-subtitle">Example 1 result</h6>

In the same way as in Freestyle Job, result can be checked in Jenkins and ElasTest.

<p></p>
<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-2" href="/docs/jenkins/images/pipeline_result.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/pipeline_result.png"/></a>
</div>

<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-2" href="/docs/jenkins/images/pipeline_result_2.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/pipeline_result_2.png"/></a>
</div>

<h6 class="small-subtitle">Example 2</h6>

We can execute this code in another Pipeline. The difference with the previous example is that in this case, we are using the EUS service adding `tss: ['EUS']`. This example will use a web browser to do a little test on it.

```
node{
    elastest(tss: ['EUS']) {
        stage ('Executing Test') {
            echo 'Print env variables'
            sh 'env'
            echo 'Set up test environment'
            mvnHome = tool 'M3.3.9'
            echo 'Cloning repository'
            git 'https://github.com/elastest/demo-projects'
            echo 'Run test'
            sh "cd ./simple-web-java-test/;'${mvnHome}/bin/mvn' test"
        }
    }
}
```


<h3 class="holder-subtitle link-top">Pipeline Job Examples</h3>

The installation of ElasTest, Jenkins and the collaboration between them, allows several configurations and offers the following options:


- **`tss: ['EUS']`**: is used to indicate to ElasTest that the job needs to use the EUS service to use a web browser.
- **`sut`**: allows to select an external Sut against which to execute the job.
- **`project`**: allows you to select the ElasTest Project where to create the new TJob from Jenkins.
- **`surefireReportsPattern`**: used to tell ElasTest the path where the test results will be located.
- **`monitoring`**: used to send or not the Sut monitoring traces to Elastest.


Bellow, you will find an example of pipeline where using the ElasTest plugin and implements severals configurations, a SUT is started and a test battery is executed on it.
To configure this option, ElasTest provides the connection info using [environment variables](/testing/environment-variables). This example is included in the Jenkins instance provided by ElasTest. If you use your own Jenkins, you will have to configure it manually in the following way:

<h4 class="small-subtitle">WebApp</h4>

This pipeline configures the ElasTes plugin, starts the SUT and clones the repository with the test to execute it.

```
node{
    elastest(tss: ['EUS'], surefireReportsPattern: '**/target/surefire-reports/TEST-*.xml', monitoring: true) {
        stage ('Executing Test') {
            echo 'Print env variables'
            sh 'env'
            def sutImage = docker.image('elastest/demo-web-java-test-sut')
            echo 'Start SUT'
            sutImage.withRun("--name ${env.ET_SUT_CONTAINER_NAME}") { c ->
                echo "${c.id}"
                def sutContainerName = env.ET_SUT_CONTAINER_NAME;
                def sutNetwork = getFirstNetwork(sutContainerName)
                def sutIp = containerIp(sutContainerName, sutNetwork)
                sh 'docker run -e IP=' + sutIp + ' -e PORT=8080 --network=' + sutNetwork + ' elastest/etm-check-service-up'
                withEnv(['ET_SUT_HOST=' + sutIp]) {
                    echo 'Set up test environment'
                    mvnHome = tool 'M3.3.9'
                    echo 'Cloning repository'
                    git 'https://github.com/elastest/demo-projects'
                    echo 'Run test'
                    sh "cd ./web-java-test/;'${mvnHome}/bin/mvn' -Dtest=WebAppTest test"
                }
            }
            
        }        
    }
}

def getFirstNetwork(containerName) {
    echo "Inside getFirstNetwork function"
    network = sh (
        script: "docker inspect " + containerName + " -f \"{{json .NetworkSettings.Networks}}\" | awk \"{sub(/:.*/,\\\"\\\")}1\" | awk \"{sub(/\\\"/,\\\"\\\")}1\" | awk \"{sub(/\\\"/,\\\"\\\")}1\" | awk \"{sub(/{/,\\\"\\\")}1\"",
        returnStdout: true
    ).trim()
    
    echo containerName+" Network = " + network;
    return network;
}

def containerIp(containerName, network) {
    echo "Inside containerIp function"
    containerIp = sh (
        script: "docker inspect --format=\"{{.NetworkSettings.Networks." + network + ".IPAddress}}\" "+ containerName,
        returnStdout: true
    ).trim()
    
    echo containerName+" IP = " + containerIp;
    return containerIp;
}
```

The example above can be split into the following sections:

*   **ElasTest plugin configuration** : You can choose to send the logs of your build

<p></p>

```
node{
    elastest() {
        .......
    {
```
<p></p>

*   **Sut configuration** : The SUT must be started, passing the `${env.ET_SUT_CONTAINER_NAME}` env variable (provided by ElasTest) as name of the container. This will allow ElasTest to receive logs and metrics from the Sut.
<p></p>

```
def sutImage = docker.image('elastest/demo-web-java-test-sut')
            echo 'Start SUT'
            sutImage.withRun("--name ${env.ET_SUT_CONTAINER_NAME}") { c ->
```
<p></p>

*   **Wait for Sut** : You have to obtain the Sut network and ip and run check image (elastest/etm-check-service-up) provided by ElasTest to wait for the Sut to be ready to be used.
<p></p>

```
def sutContainerName = env.ET_SUT_CONTAINER_NAME;
            def sutNetwork = getFirstNetwork(sutContainerName)
            def sutIp = containerIp(sutContainerName,network)
            sh 'docker run -e IP=' + sutIp + ' -e PORT=8080 --network=' + sutNetwork + ' elastest/etm-check-service-up'
```
<p></p>

*   **Test Execution** : Finally, the tests should be executed to verify that the SUT is working correctly. Remember that you have to configure the Sut ip as a environment variable or pass it as a maven property due to the browsers we have used need to know where is the SUT located.

<p></p>

```
....
withEnv(['ET_SUT_HOST=' + sutIp]) {
            echo 'Set up test environment'
            mvnHome = tool 'M3.3.9'
            echo 'Cloning repository'
            git 'https://github.com/elastest/demo-projects'
            echo 'Run test'
            sh "cd ./web-java-test/;'${mvnHome}/bin/mvn' -Dtest=WebAppTest test"
        }
....
```

<div class="range range-xs-center warning-range">
  <div class="cell-xs-4 cell-lg-1 cell-lg-push-1" style="text-align: center;"><span class="icon mdi mdi-information-outline warning-span"></span></div>
  <div class="cell-xs-8 cell-lg-11 cell-lg-push-11 warning-text"><p><i>You can refresh your mind visiting our tutorial <a href="/docs/testing/e2e-rest">How implement a test</a>.</i></p></div>
</div>