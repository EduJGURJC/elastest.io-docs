<div class="range range-xs-left">
<div class="cell-xs-10 cell-lg-6 text-md-left inset-md-right-80 cell-lg-push-1 offset-top-50 offset-lg-top-0">
<h2 id="content" class="h1">Pipeline Job</h2>
<div class="offset-top-30 offset-md-top-30">
</div>
</div>
</div>

You can create Pipeline Jobs in Jenkins that make use of the ElasTest plugin.

From a Pipeline this plugin allows:

-   Send the **`Jobâ€™s logs`** to ElasTest.
-   **`Use the browsers`** you need in the tests executed during a build. To do this, you must indicate that you want the provision of a EUS TSS, passing this requirement as a parameter in the plugin.
-   Send **`logs and metrics`** of a dockerized [Sut](/testing/sut) from a Job's execution to ElasTest and the logs generated by the browsers used.
-   **Run a** [Sut](/testing/sut) using docker or docker-compose

Let's see how to create a basic Jenkins Job that uses the plugin. This Job will run the demo example [JUnit5 Unit Test](https://github.com/elastest/demo-projects/tree/master/unit/junit5-unit-test), which has a single class with two methods, sum and sub, that receive two numerical values to add or subtract respectively.
This test has been developed in Java using [JUnit5](https://junit.org/junit5/).

The script that will contain the Job is as follows:

```
node{
    elastest(surefireReportsPattern: '**/target/surefire-reports/TEST-*.xml', project: 'Jenkins Examples') {
        stage ('Executing Test') {
            echo 'Set up test environment'
            mvnHome = tool 'M3.3.9'
            echo 'Cloning repository'
            git 'https://github.com/elastest/demo-projects'
            echo 'Run test'
            sh "cd ./unit/junit5-unit-test;'${mvnHome}/bin/mvn' -B -DforkCount=0 test"
            step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])
        }        
    }
}
```

The script above can be split into the following sections:

-   **ElasTest plugin block with configuration** : this block will contain all the steps that the test must follow, as well as the necessary configuration:
    -   **`surefireReportsPattern`** will contain the path where the xml files containing the test results are stored and which will be used by ElasTest to display the test information. We explain this in more detail <a href="/docs/testing/unit#xmlAndtestResultsPath">here</a>.
    -   **`project`** is used to indicate the name of the ElasTest project where the TJob associated with Jenk's Job will be created. This field is optional and if it is not used, a project will be created with the same name as the Job.
<p></p>

```
node{
    elastest(surefireReportsPattern: '**/target/surefire-reports/TEST-*.xml', project: 'Jenkins Examples') {
        .......
    {
}
```
<p></p>

-   **Test Execution** : Basically the following steps are followed:
    -   The [GitHub repository](https://github.com/elastest/demo-projects) containing the tests is cloned. **`git 'https://github.com/elastest/demo-projects'`**
    -   You access the folder containing the tests: **`cd ./unit/junit5-unit-test`**
    -   The tests are executed: **`'${mvnHome}/bin/mvn' -B -DforkCount=0 test`**


<p></p>

```
....
stage ('Executing Test') {
        echo 'Set up test environment'
        mvnHome = tool 'M3.3.9'
        echo 'Cloning repository'
        git 'https://github.com/elastest/demo-projects'
        echo 'Run test'
        sh "cd ./unit/junit5-unit-test;'${mvnHome}/bin/mvn' -B -DforkCount=0 test"
        step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])
}        
....
```
<p></p>


You must [access Jenkins](/jenkins/try-jenkins), create a Pipeline Job with the name you want (we'll use **jenkins-junit5-unit-test**), insert the script and save:

<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-2" href="/docs/jenkins/images/pipeline/junit5_unit_test_pipeline_script.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/pipeline/junit5_unit_test_pipeline_script.png"/></a>
</div>

Once created, you can execute it as follows:

<h5 class="small-subtitle">1. Click to "Build now" button</h5>

<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-1" href="/docs/jenkins/images/try/jenkins_junit_example_main_build_btn.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/try/jenkins_junit_example_main_build_btn.png"/></a>
</div>


<h5 class="small-subtitle">2. Running view</h5>

After pressing the button, you will see the job running on Jenkins:

<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-1" href="/docs/jenkins/images/try/jenkins_junit_example_running.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/try/jenkins_junit_example_running.png"/></a>
</div>

On the other hand, ElasTest will have created a project called **`Jenkins Examples`** in **Projects section**, that will contain a TJob with the same name as Jenkins Job (jenkins-junit5-unit-test). 

<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-1" href="/docs/jenkins/images/try/elastest_jenkins_project.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/try/elastest_jenkins_project.png"/></a>
</div>

Navigating to this TJob you can see the current execution:

<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-1" href="/docs/jenkins/images/try/elastest_junit_example_running.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/try/elastest_junit_example_running.png"/></a>
</div>

<h5 class="small-subtitle">3. Results view</h5>

Once the execution is complete, you can view it in both Jenkins and ElasTest

<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-1" href="/docs/jenkins/images/try/jenkins_junit_example_end.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/try/jenkins_junit_example_end.png"/></a>
</div>

<div class="docs-gallery inline-block">
    <a data-fancybox="gallery-1" href="/docs/jenkins/images/try/elastest_junit_example_end.png"><img class="img-responsive img-wellcome" src="/docs/jenkins/images/try/elastest_junit_example_end.png"/></a>
</div>

As can be seen in the last image, ElasTest shows different information, such as **test results** or **logs**. You can also see a card of metrics (All Metrics), but in this particular test is not sent any so it will appear empty.

<!-- ******************************** -->
<!-- ******* Advanced Example ******* -->
<!-- ******************************** -->

<h4 class="holder-subtitle link-top">Advanced Example</h4>

The installation of ElasTest, Jenkins and the collaboration between them, allows several configurations and offers the following options:

-   **`tss: ['EUS']`**: is used to indicate to ElasTest that the job needs to use the EUS service to use a web browser.
-   **`sut`**: allows to select an external Sut against which to execute the job.
-   **`project`**: allows you to select the ElasTest Project where to create the new TJob from Jenkins.
-   **`surefireReportsPattern`**: used to tell ElasTest the path where the test results will be located.
-   **`monitoring`**: used to send or not the Sut monitoring traces to Elastest.

Bellow, you will find an example of pipeline where using the ElasTest plugin and implements severals configurations, a [Sut](/testing/sut) is started and a test battery is executed on it.
To configure this option, ElasTest provides the connection info using [environment variables](/testing/environment-variables). This example is included in the Jenkins instance provided by ElasTest. If you use your own Jenkins, you will have to configure it manually in the following way:

<h5 class="small-subtitle">JUnit5 Multi Browser Test</h5>

This pipeline configures the ElasTes plugin, starts the SUT and clones the repository with the test to execute it.

```
node{
    elastest(tss: ['EUS'], surefireReportsPattern: '**/target/surefire-reports/TEST-*.xml', monitoring: true, project: 'Jenkins Examples') {
        stage ('Executing Test') {
            echo 'Print env variables'
            sh 'env'
            def sutImage = docker.image('elastest/demo-web-java-test-sut')
            echo 'Start SUT'
            sutImage.withRun("--name ${env.ET_SUT_CONTAINER_NAME}") { c ->
                echo "${c.id}"
                def sutContainerName = env.ET_SUT_CONTAINER_NAME;
                def sutNetwork = getFirstNetwork(sutContainerName)
                def sutIp = containerIp(sutContainerName,sutNetwork)
                sh 'docker run -e IP=' + sutIp + ' -e PORT=8080 --network=' + sutNetwork + ' elastest/etm-check-service-up'
                withEnv(['ET_SUT_HOST=' + sutIp]) {
                    echo 'Set up test environment'
                    mvnHome = tool 'M3.3.9'
                    echo 'Cloning repository'
                    git 'https://github.com/elastest/demo-projects'
                    echo 'Run test'
                    sh "cd ./webapp/junit5-web-multiple-browsers-test/;'${mvnHome}/bin/mvn' -Dbrowser=chrome -DforkCount=0 test"
                }
            }
            
        }        
    }
}

def getFirstNetwork(containerName) {
    echo "Inside getFirstNetwork function"
    network = sh (
        script: "docker inspect " + containerName + " -f \"{{json .NetworkSettings.Networks}}\" | awk \"{sub(/:.*/,\\\"\\\")}1\" | awk \"{sub(/\\\"/,\\\"\\\")}1\" | awk \"{sub(/\\\"/,\\\"\\\")}1\" | awk \"{sub(/{/,\\\"\\\")}1\"",
        returnStdout: true
    ).trim()
    
    echo containerName+" Network = " + network;
    return network;
}

def containerIp(containerName, network) {
    echo "Inside containerIp function"
    containerIp = sh (
        script: "docker inspect --format=\"{{.NetworkSettings.Networks." + network + ".IPAddress}}\" "+ containerName,
        returnStdout: true
    ).trim()
    
    echo containerName+" IP = " + containerIp;
    return containerIp;
}
```

The example above can be split into the following sections:

-   **ElasTest plugin block with configuration** : this block will contain all the steps that the test must follow, as well as the necessary configuration.

<p></p>

```
node{
    elastest(tss: ['EUS'], surefireReportsPattern: '**/target/surefire-reports/TEST-*.xml', monitoring: true, project: 'Jenkins Examples') {
        .......
    }
}
```

<p></p>

-   **Sut configuration** : The SUT must be started, passing the `${env.ET_SUT_CONTAINER_NAME}` env variable (provided by ElasTest) as name of the container. This will allow ElasTest to receive logs and metrics from the Sut.
    <p></p>

```
def sutImage = docker.image('elastest/demo-web-java-test-sut')
echo 'Start SUT'
sutImage.withRun("--name ${env.ET_SUT_CONTAINER_NAME}") { c ->
```

<p></p>

-   **Wait for Sut** : You have to obtain the Sut network and ip and run check image (elastest/etm-check-service-up) provided by ElasTest to wait for the Sut to be ready to be used.
    <p></p>

```
def sutContainerName = env.ET_SUT_CONTAINER_NAME;
def sutNetwork = getFirstNetwork(sutContainerName)
def sutIp = containerIp(sutContainerName,sutNetwork)
sh 'docker run -e IP=' + sutIp + ' -e PORT=8080 --network=' + sutNetwork + ' elastest/etm-check-service-up'ocker run -e IP=' + sutIp + ' -e PORT=8080 --network=' + sutNetwork + ' elastest/etm-check-service-up'
```

<p></p>

-   **Test Execution** : Finally, the tests should be executed to verify that the SUT is working correctly. Remember that you have to configure the Sut ip as a environment variable or pass it as a maven property due to the browsers we have used need to know where is the SUT located.

<p></p>

```
....
withEnv(['ET_SUT_HOST=' + sutIp]) {
    echo 'Set up test environment'
    mvnHome = tool 'M3.3.9'
    echo 'Cloning repository'
    git 'https://github.com/elastest/demo-projects'
    echo 'Run test'
    sh "cd ./webapp/junit5-web-multiple-browsers-test/;'${mvnHome}/bin/mvn' -Dbrowser=chrome -DforkCount=0 test"
}
....
```